<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi kalkulaÄka</title>

<style>
body {
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#f2f2f2;
  padding:12px;
  margin:0;
}
h1 { text-align:center; }

.card {
  background:white;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
}
label { font-weight:600; display:block; margin-top:10px; }
input,button {
  width:100%;
  padding:12px;
  font-size:16px;
  margin-top:6px;
}
button {
  background:#007aff;
  color:white;
  border:none;
  border-radius:10px;
}
iframe {
  width:100%;
  height:280px;
  border-radius:12px;
  border:none;
}
.result {
  font-size:18px;
  font-weight:bold;
}
.green { color:green; }
</style>
</head>

<body>

<h1>ğŸš• Taxi kalkulaÄka</h1>

<div class="card">
  <label>Poloha vozidla</label>
  <input id="vehicle" readonly placeholder="GPS nenaÄÃ­tanÃ©">
  <button onclick="loadGPS()">ğŸ“ NaÄÃ­taÅ¥ polohu</button>

  <label>NÃ¡stup klienta</label>
  <input id="startAddr" placeholder="Ulica, mesto">

  <label>CieÄ¾ klienta</label>
  <input id="endAddr" placeholder="Ulica, mesto">
</div>

<iframe id="map"
src="https://www.openstreetmap.org/export/embed.html?layer=mapnik">
</iframe>

<div id="result" class="card result">
  ÄŒakanie na Ãºdajeâ€¦
</div>

<script>
const RATE_PICKUP = 0.31;
const RATE_RIDE = 0.85;

let vehicleCoords = null;
let startCoords = null;
let endCoords = null;

/* ===== GPS ===== */
function loadGPS(){
  navigator.geolocation.getCurrentPosition(p=>{
    vehicleCoords = {
      lat: p.coords.latitude,
      lon: p.coords.longitude
    };
    vehicle.value = "Poloha naÄÃ­tanÃ¡";
    updateMap(vehicleCoords.lat, vehicleCoords.lon);
  });
}

/* ===== GEOCODING (OSM NOMINATIM) ===== */
async function geocode(addr){
  const url =
    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`;
  const r = await fetch(url);
  const j = await r.json();
  if(!j.length) throw "Adresa nenÃ¡jdenÃ¡";
  return { lat:+j[0].lat, lon:+j[0].lon };
}

/* ===== MAPA ===== */
function updateMap(lat,lon){
  map.src =
    `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.02},${lat-0.02},${lon+0.02},${lat+0.02}&layer=mapnik&marker=${lat},${lon}`;
}

/* ===== OSRM ===== */
async function km(a,b,c,d){
  const r = await fetch(
    `https://router.project-osrm.org/route/v1/driving/${b},${a};${d},${c}?overview=false`
  );
  const j = await r.json();
  return j.routes[0].distance/1000;
}

/* ===== VÃPOÄŒET ===== */
async function calculate(){
  if(!vehicleCoords || !startCoords || !endCoords) return;

  const k1 = await km(vehicleCoords.lat, vehicleCoords.lon, startCoords.lat, startCoords.lon);
  const k2 = await km(startCoords.lat, startCoords.lon, endCoords.lat, endCoords.lon);

  const sum = k1*RATE_PICKUP + k2*RATE_RIDE;
  result.innerText = `Cena / NÃ¡klady: ${sum.toFixed(2)} â‚¬`;
  result.className = "card result green";
}

/* ===== EVENTY ===== */
startAddr.onchange = async ()=>{
  try {
    startCoords = await geocode(startAddr.value);
    updateMap(startCoords.lat,startCoords.lon);
    calculate();
  } catch(e){ alert("NÃ¡stup: adresa nenÃ¡jdenÃ¡"); }
};

endAddr.onchange = async ()=>{
  try {
    endCoords = await geocode(endAddr.value);
    updateMap(endCoords.lat,endCoords.lon);
    calculate();
  } catch(e){ alert("CieÄ¾: adresa nenÃ¡jdenÃ¡"); }
};
</script>

</body>
</html>
