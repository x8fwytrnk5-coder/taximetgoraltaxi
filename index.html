<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi kalkulaƒçka</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f2f2f2;margin:0;padding:12px;}
h1{text-align:center;}
.card{background:white;padding:14px;border-radius:12px;margin-bottom:12px;}
label{font-weight:600;margin-top:10px;display:block;}
input,button{width:100%;padding:12px;font-size:16px;margin-top:6px;}
button{background:#007aff;color:white;border:none;border-radius:10px;}
iframe{width:100%;height:260px;border:none;border-radius:12px;}
.result{font-size:18px;font-weight:bold;}
.green{color:green;}
.red{color:red;}
</style>
</head>
<body>

<h1>üöï Taxi kalkulaƒçka</h1>

<div class="card">
  <label>Poloha vozidla (GPS alebo ruƒçne)</label>
  <input id="vehicleLat" placeholder="Zadajte lat" type="number" step="any">
  <input id="vehicleLon" placeholder="Zadajte lon" type="number" step="any">
  <button onclick="loadGPS()">üìç Naƒç√≠ta≈• GPS</button>

  <label>Miesto n√°stupu klienta</label>
  <input id="startAddr" placeholder="Ulica, mesto">

  <label>Cieƒæ klienta</label>
  <input id="endAddr" placeholder="Ulica, mesto">

  <label>Cena z cenn√≠ka (‚Ç¨)</label>
  <input id="priceCennik" placeholder="Zadajte cenu z cenn√≠ka">
</div>

<iframe id="map" src="https://www.openstreetmap.org/export/embed.html?layer=mapnik"></iframe>

<div class="card result" id="result">
  ƒåakanie na √∫daje‚Ä¶
</div>

<script>
const COST_RATE = 0.31;
let vehicle=null;

// ===== GPS s timeout, high accuracy a fallback =====
function loadGPS(){
  if(!navigator.geolocation){
    alert("Va≈°e zariadenie nepodporuje GPS. Zadajte s√∫radnice ruƒçne.");
    return;
  }

  document.getElementById("result").innerText = "Naƒç√≠tavam GPS‚Ä¶";
  navigator.geolocation.getCurrentPosition(
    pos => {
      vehicle = {lat: pos.coords.latitude, lon: pos.coords.longitude};
      document.getElementById("vehicleLat").value = vehicle.lat;
      document.getElementById("vehicleLon").value = vehicle.lon;
      document.getElementById("result").innerText = "GPS naƒç√≠tan√©";
      updateMap(vehicle.lat, vehicle.lon);
      calculate();
    },
    err => {
      alert("Nepodarilo sa naƒç√≠ta≈• GPS: " + err.message + ". Zadajte s√∫radnice ruƒçne alebo sk√∫ste GPS znovu.");
      document.getElementById("result").innerText = "Zadajte s√∫radnice ruƒçne alebo pou≈æite GPS znovu.";
    },
    {enableHighAccuracy:true, timeout:15000, maximumAge:0}
  );
}

// ===== Z√≠skanie s√∫radn√≠c vozidla =====
function getVehicleCoords(){
  const lat = parseFloat(document.getElementById("vehicleLat").value);
  const lon = parseFloat(document.getElementById("vehicleLon").value);
  if(!isNaN(lat) && !isNaN(lon)){
    return {lat, lon};
  } else if(vehicle){
    return vehicle;
  }
  return null;
}

// ===== GEOCODING =====
async function geocode(address){
  try{
    if(!address) throw "Pr√°zdna adresa";
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
    const j = await r.json();
    if(!j.length) throw "Adresa nen√°jden√°";
    return {lat:+j[0].lat, lon:+j[0].lon};
  } catch(err){
    throw "Chyba geok√≥dovania: " + err;
  }
}

// ===== MAPA =====
function updateMap(lat,lon){
  map.src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.02},${lat-0.02},${lon+0.02},${lat+0.02}&layer=mapnik&marker=${lat},${lon}`;
}

// ===== TRASA =====
async function routeKm(a,b,c,d){
  try{
    const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${b},${a};${d},${c}?overview=false`);
    const j = await r.json();
    if(!j.routes || !j.routes[0]) throw "Trasa nen√°jden√°";
    return j.routes[0].distance/1000;
  } catch(err){
    throw "Chyba OSRM: " + err;
  }
}

// ===== V√ùPOƒåET =====
async function calculate(){
  try{
    const vehicleCoords = getVehicleCoords();
    if(!vehicleCoords){
      document.getElementById("result").innerText = "Zadajte polohu vozidla (GPS alebo ruƒçne)";
      return;
    }

    const startVal = document.getElementById("startAddr").value.trim();
    const endVal   = document.getElementById("endAddr").value.trim();
    const priceCennik = parseFloat(document.getElementById("priceCennik").value);

    if(!startVal || !endVal){
      document.getElementById("result").innerText = "Zadajte adresy n√°stupu a cieƒæa";
      return;
    }
    if(isNaN(priceCennik)){
      document.getElementById("result").innerText = "Zadajte platn√∫ cenu z cenn√≠ka";
      return;
    }

    const start = await geocode(startVal);
    const end   = await geocode(endVal);

    const kmPickup = await routeKm(vehicleCoords.lat, vehicleCoords.lon, start.lat, start.lon);
    const kmRide   = await routeKm(start.lat, start.lon, end.lat, end.lon);

    const costs = (kmPickup + kmRide) * COST_RATE;
    const profit = priceCennik - costs;

    document.getElementById("result").innerHTML=`
      N√°klady: ${costs.toFixed(2)} ‚Ç¨<br>
      Cena z cenn√≠ka: ${priceCennik.toFixed(2)} ‚Ç¨<br>
      Zisk / Strata: ${profit.toFixed(2)} ‚Ç¨
    `;

    document.getElementById("result").className = "card result " + (profit>=0?"green":"red");

    updateMap((vehicleCoords.lat + start.lat + end.lat)/3, (vehicleCoords.lon + start.lon + end.lon)/3);

  } catch(err){
    console.log(err);
    document.getElementById("result").innerText = "Chyba: " + err;
    document.getElementById("result").className = "card result red";
  }
}

// ===== EVENTY =====
document.getElementById("startAddr").oninput = calculate;
document.getElementById("endAddr").oninput = calculate;
document.getElementById("priceCennik").oninput = calculate;
document.getElementById("vehicleLat").oninput = calculate;
document.getElementById("vehicleLon").oninput = calculate;

</script>
</body>
</html>
