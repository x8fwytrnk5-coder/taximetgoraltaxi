<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi ‚Äì kalkulaƒçka n√°kladov</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:12px;
}
h1 { text-align:center; }
.card {
  background:#fff;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
}
label {
  font-weight:600;
  margin-top:10px;
  display:block;
}
input, button {
  width:100%;
  padding:12px;
  font-size:16px;
  margin-top:6px;
}
button {
  background:#007aff;
  color:#fff;
  border:none;
  border-radius:10px;
}
button.secondary {
  background:#34c759;
}
.result {
  font-size:18px;
  font-weight:bold;
}
.green { color:#0a7d00; }
.red { color:#c10000; }
iframe {
  width:100%;
  height:260px;
  border:none;
  border-radius:12px;
}
</style>
</head>

<body>

<h1>üöï Taxi kalkulaƒçka</h1>

<div class="card">
  <label>Poloha vozidla (GPS alebo ruƒçne)</label>
  <input id="vehLat" placeholder="Latitude" type="number" step="any">
  <input id="vehLon" placeholder="Longitude" type="number" step="any">
  <button onclick="loadGPS()">üìç Naƒç√≠ta≈• GPS</button>

  <label>Miesto n√°stupu klienta</label>
  <input id="startAddr" placeholder="Ulica, mesto">

  <label>Cieƒæ klienta</label>
  <input id="endAddr" placeholder="Ulica, mesto">

  <label>Cena z cenn√≠ka (‚Ç¨)</label>
  <input id="priceInput" placeholder="Zadajte cenu">

  <button class="secondary" onclick="calculate()">Vypoƒç√≠ta≈•</button>
</div>

<iframe id="map" src="https://www.openstreetmap.org/export/embed.html?layer=mapnik"></iframe>

<div class="card result" id="result">
  Pripraven√© na v√Ωpoƒçet
</div>

<script>
/* ================== KON≈†TANTY ================== */
const COST_RATE = 0.31;
const GEO_CACHE_TTL = 24 * 60 * 60 * 1000;

/* ================== CACHE ================== */
const geoCache = {};
let vehicleCoords = null;

/* ================== GPS ================== */
function loadGPS(){
  if(!navigator.geolocation){
    alert("GPS nie je podporovan√©.");
    return;
  }
  result.textContent = "Naƒç√≠tavam GPS‚Ä¶";
  navigator.geolocation.getCurrentPosition(
    pos => {
      vehicleCoords = {
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      };
      vehLat.value = vehicleCoords.lat;
      vehLon.value = vehicleCoords.lon;
      updateMap(vehicleCoords.lat, vehicleCoords.lon);
      result.textContent = "GPS naƒç√≠tan√©";
    },
    err => {
      result.textContent = "GPS zlyhalo ‚Äì zadajte s√∫radnice ruƒçne";
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* ================== GEOCODING ================== */
async function geocodeAddress(address, retries = 2){
  if(!address || address.length < 3)
    throw "Neplatn√° adresa";

  const now = Date.now();
  if(geoCache[address] && (now - geoCache[address].time) < GEO_CACHE_TTL)
    return geoCache[address].coords;

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000);

  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(address)}`,
      {
        signal: controller.signal,
        headers:{
          "Accept":"application/json",
          "User-Agent":"TaxiKalkulacka/1.0"
        }
      }
    );

    if(!res.ok) throw "HTTP chyba";

    const data = await res.json();
    if(!data.length) throw "Adresa nen√°jden√°";

    const coords = {
      lat: parseFloat(data[0].lat),
      lon: parseFloat(data[0].lon)
    };

    geoCache[address] = { coords, time: now };
    return coords;

  } catch(err){
    if(retries > 0){
      await new Promise(r => setTimeout(r, 800));
      return geocodeAddress(address, retries - 1);
    }
    throw err;
  } finally {
    clearTimeout(timeout);
  }
}

/* ================== TRASA ================== */
async function routeKm(aLat,aLon,bLat,bLon){
  const res = await fetch(
    `https://router.project-osrm.org/route/v1/driving/${aLon},${aLat};${bLon},${bLat}?overview=false`
  );
  const data = await res.json();
  if(!data.routes || !data.routes.length)
    throw "Trasa nen√°jden√°";
  return data.routes[0].distance / 1000;
}

/* ================== MAPA ================== */
function updateMap(lat,lon){
  map.src =
    `https://www.openstreetmap.org/export/embed.html?` +
    `bbox=${lon-0.02},${lat-0.02},${lon+0.02},${lat+0.02}` +
    `&layer=mapnik&marker=${lat},${lon}`;
}

/* ================== HLAVN√ù V√ùPOƒåET ================== */
async function calculate(){
  try {
    result.textContent = "Poƒç√≠tam‚Ä¶";

    const vLat = parseFloat(vehLat.value);
    const vLon = parseFloat(vehLon.value);
    if(isNaN(vLat) || isNaN(vLon))
      throw "Ch√Ωba poloha vozidla";

    const price = parseFloat(priceInput.value);
    if(isNaN(price))
      throw "Ch√Ωba cena z cenn√≠ka";

    const start = await geocodeAddress(startAddr.value);
    const end   = await geocodeAddress(endAddr.value);

    const km1 = await routeKm(vLat, vLon, start.lat, start.lon);
    const km2 = await routeKm(start.lat, start.lon, end.lat, end.lon);

    const costs = (km1 + km2) * COST_RATE;
    const diff = price - costs;

    result.innerHTML = `
      N√°klady: ${costs.toFixed(2)} ‚Ç¨<br>
      Cena z cenn√≠ka: ${price.toFixed(2)} ‚Ç¨<br>
      V√Ωsledok: ${diff.toFixed(2)} ‚Ç¨
    `;
    result.className = "card result " + (diff >= 0 ? "green" : "red");

    updateMap(
      (vLat + start.lat + end.lat) / 3,
      (vLon + start.lon + end.lon) / 3
    );

  } catch(err){
    result.textContent = "Chyba: " + err;
    result.className = "card result red";
  }
}
</script>

</body>
</html>
